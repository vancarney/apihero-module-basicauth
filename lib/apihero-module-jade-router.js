// Generated by CoffeeScript 1.9.0
var RouteManager, RoutesMonitor, fs, path, _;

fs = require('fs');

path = require('path');

_ = require('lodash');

module.exports.init = function(app, options) {
  var views;
  views = './views';
  return app.once('ahero-initialized', (function(_this) {
    return function() {
      var done;
      done = _.after(app.ApiHero.loadedModules.length, function(views) {
        var _routeManager;
        app.set('view engine', 'jade');
        app.set('views', './views');
        return _routeManager = RouteManager.getInstance();
      });
      app.ApiHero.createSyncInstance('route', RoutesMonitor).addSyncHandler('route', 'added', function(op) {
        var route, _ref, _rm;
        _rm = RouteManager.getInstance();
        if ((_ref = (route = _rm.getRoute(op.name))) != null ? _ref.length : void 0) {
          return _rm.createRoute(route[0], function(e) {
            if (e != null) {
              return console.log(e);
            }
            return setTimeout(((function(_this) {
              return function() {
                return (require("" + (path.join(process.cwd(), route[0].route_file)))).init(app);
              };
            })(this)), 100);
          });
        }
      });
      if (!app.ApiHero.loadedModules.length) {
        return done();
      }
      return _.each(app.ApiHero.loadedModules, function(name) {
        var module, _i, _len, _ref;
        if (!(module = require(name)).hasOwnProperty('paths' && module.paths.length > 1)) {
          done(views);
        }
        _ref = module.paths;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          path = _ref[_i];
          if ((path.match(/\.jade+$/)) != null) {
            views.concat(path);
          }
        }
        return done(views);
      });
    };
  })(this));
};

RouteManager = require('./RouteManager');

RoutesMonitor = require('./RoutesMonitor');
